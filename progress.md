Original prompt: Get rid of need for manuals folder. Go through the code and make sure it no longer requires pulls to the manual.

- Removed all `assets/manual` sheet paths from `SHEET_PATHS`.
- Removed legacy `SPRITE_LAYOUT` manual fallback mapping.
- Switched to strict custom-only sprite source (`MONTH_SPRITES`) for all 12 months.
- Added fail-fast guard in `buildDeck()` if any month sprite mapping is missing.
- Next: delete `assets/manual` folder and verify no references remain.
- Deleted `assets/manual` folder from the project.
- Verified there are no remaining `assets/manual` or legacy manual-sheet identifiers in `game.js`, `index.html`, or `style.css`.
- Validation limits: runtime smoke test not executed here because local `node` is unavailable in this environment.
- Implemented 4-of-month sweep capture rule:
  - Phase 1 (hand play): if 3 matching month cards are on field, playing 4th card captures all 4.
  - Phase 2 (deck draw): if drawn card matches 3 field cards of same month, captures all 4.
- Updated human selection flow so only 2-match cases prompt for field choice.
- Updated AI move evaluation to recognize and value 4-card month sweeps.
- Added helper `takeAllMonthMatchesFromField(month)`.
- Validation limits: runtime smoke test not executed here because local `node` is unavailable in this environment.
- Phase 1 interaction change implemented: human must click field card to collect whenever there is a match (1, 2, or 3).
- Hand phase now enters selection mode for 1/2/3 matches instead of auto-capturing 1 and 3.
- Draw phase now enters selection mode for human for 1/2/3 matches; resolution handles 3-match sweep capture.
- CPU flow unchanged in this phase (still auto-resolves).
- Validation limits: runtime smoke test not executed because local `node` is unavailable in this environment.
- Phase 2 implemented: CPU readability/pacing layer.
- Added staged CPU beats with delays:
  - think beat before playing hand card
  - field target preview beat (highlights target/sweep set)
  - delayed draw resolution beat after deck pull outcome
  - delayed pass vs koi-koi decision beat
- Added `state.aiPreview` and render support so field highlights are visible during CPU planning.
- Added `scheduleAIStep()` and refactored AI timers to support multi-step CPU turn pacing.
- Added `ai_preview` output in `renderGameToText` for deterministic inspection.
- Validation limits: runtime smoke test not executed because local `node` is unavailable in this environment.
- Phase 3 implemented: CPU now simulates field-pick interaction for deck-draw matches.
- For CPU draw matches (1/2/3), game now shows aiPreview highlight + prompt, pauses, then auto-confirms capture.
- 3-match draw case now visually previews sweep before capturing all four.
- Added player-only deck flip phase for draw step:
  - after phase-1 resolves, drawn card is staged face-down in Recent Deck Pull
  - player must tap Recent Deck Pull to reveal
  - reveal lingers briefly before resolving to field/capture selection
- Added `awaitingDeckFlip` state + draw reveal timer and cleanup hooks.
- Added deck panel glow/pulse + pointer cursor while awaiting player flip.
- Added `awaiting_deck_flip` in `renderGameToText`.
- Implemented deck-flip phase for CPU (Step 2):
  - CPU now stages face-down draw in Recent Deck Pull
  - auto-reveals after short delay
  - lingers face-up briefly
  - then resolves to no-match field land or existing CPU match-preview/capture flow
- `awaitingDeckFlip` now covers both player and CPU and is exposed in `renderGameToText` with owner name.
- Rule update: Sake Cup (9a) no longer counts as a basic/plain card.
- Kept Sake Cup as seed and preserved Moon/Blossom viewing yaku checks.
- Updated both scoring and AI captured-stat calculations to remove Sake-as-basic contribution.
- Added a second card corner indicator for card type beside month indicator.
- New type badge codes: `BRT` (light), `SED` (seed), `SCR` (scroll), `PLN` (basic/plain).
- Badge rendering now uses inline badge elements on cards (hand, field, and captured mini cards), not pseudo-content strings.
- Type badge is elongated and color-coded by type; month badge remains compact and immediately to its right.
- Mini captured cards also show both badges with scaled-down sizing.
- Validation limits: unable to run `node`/Playwright in this environment (`node: command not found`), so runtime smoke test was not executed here.
- Swapped badge positions per UI request: month badge is now on the left, type badge on its right (including mini cards).
- Capture display now auto-sorts on every render (no mutation of source captured arrays).
- Display order implemented: bright -> seed -> text scroll -> blue scroll -> red scroll -> plain.
- Tie-breakers: month ascending, then card id for deterministic left-to-right ordering.
- Moved type badge to top-right of cards; month badge remains top-left.
- Applied to both regular and mini cards via CSS-only position updates.
- Moved rules panel section to render below the bottom title bar (`Hanafuda Koi-Koi` + rules toggle).
- Rules toggle behavior unchanged, but expanded rules now appear directly underneath that bar.
- Rules panel scroll behavior hardened: panel has `max-height: 42vh` and `overflow-y: auto`.
- Converted rules content into expandable accordion sections using native `<details>` blocks.
- Each major rules group now expands/collapses independently in the rules panel.
- Added accordion styling for section headers, plus/minus indicator, and section body spacing.
- Corrected rules text note: Sake Cup does not count as basic.
- Replaced rules panel text with the new player-friendly instruction set from chat.
- Kept accordion UI and section-by-section expand/collapse behavior.
- New sections now include: Objective, Cards and Matching, Setup, Turn Structure, Capture Rules, Yaku/Pass/Koi-Koi, Round-to-Round Start Rules, Scoring, Quick Start.
- Added CPU phase-1 selected-card preview in CPU profile panel (avatar area).
- During CPU turn, selected hand card now shows briefly before the card is played to field.
- Preview uses new `cpu-phase1-preview-canvas` and temporary state `cpuPhase1PreviewCardId`.
- Avatar hides during preview and restores automatically when phase-1 resolve begins.
- Added `cpu_phase1_preview` to `render_game_to_text` payload for test/debug visibility.
- Validation: static server checks for index/js/css returned HTTP 200; Playwright smoke could not run here because `npx` is unavailable.
- Fixed CPU profile default layout artifact by forcing hidden phase1 preview canvas to fully collapse (`display: none !important` when `[hidden]`).
- Moved score/meta row (`CPU | Game x/12 Starts/Turn | You`) below context action bar.
- Relocated `Table Xx | Last Koi-Koi` indicator into field section on a centered status row.
- Added multiplier intensity visuals for table indicator via classes `mult-1..mult-4`:
  - 1x neutral
  - 2x warmer with light pulse/glow
  - 3x stronger orange-red pulse/glow
  - 4x red with strongest pulse/glow
- `renderTop()` now updates multiplier class each frame based on `state.tableMultiplier`.
- Updated hand instruction note behavior: now shows "Pick a card from your hand to play." when it's the human's actionable hand-selection state.
- Note priority now is: field choice > deck reveal > hand pick > hidden.
- Made hand instruction bar persistent to prevent layout shifting (always rendered with fixed min-height).
- Added note state styling classes: active (blue) vs muted (dim).
- Updated note logic to include simple CPU state text: "CPU playing.".
- Idle state now shows blank text in the same persistent bar.
- Extended persistent instruction bar to guide decision and progression states.
- Added human decision prompt with multiplier hint: "Choose Pass, or Koi-Koi for +Xx (to Yx)."
- Added forced-koi message when pass is disabled.
- Added round-end prompt: winner/no-scorer summary + "Click Next Game."
- Added match-end prompt: final score summary + "Click New Match."
- Replaced one-off field choice auto-scroll with centralized action-target snapping.
- Added `focusActiveActionTarget()` with priority-based targets:
  - field choice -> field
  - draw reveal -> recent deck pull
  - pass/koi or next/new buttons -> context bar
  - actionable hand pick -> player hand zone
  - CPU active turn -> field (or recent deck pull during draw reveal)
- Added dedupe guard (`autoFocusTargetKey`) so repeated renders don't keep re-snapping the same target.
- Replaced center-based auto snap with smart minimal-scroll behavior.
- New helper `scrollTargetIntoViewSmart()` scrolls only enough to keep target visible, with bottom-edge bias.
- Action targets now avoid center overshoot and appear near the bottom of viewport when scrolled into view.
- Removed field helper chip from field header to avoid overlapping/unreadable popups near multiplier status.
- Deleted `#field-helper` element from HTML, removed helper styles, and removed helper update logic in `renderChoiceMode()`.
- Guidance is now exclusively through the persistent instruction bar above the player hand.
- Removed CPU profile risk-style subtitle (High Risk / Balanced / Low Risk) from UI.
- CPU profile now shows only avatar and CPU name label.
- Mobile-only CPU hand layout updated to 4 columns x 2 rows (`max-width: 699px`), while desktop remains 8 columns x 1 row.
- Added explicit round-start snap to top in `startRound()`.
- Reset `autoFocusTargetKey` at round start so action-target snapping resumes cleanly after top reset.
- Implemented phase 1 + 2 foundation for start/load flow and game codes.
- Added startup menu gating:
  - `init()` now shows start menu after assets preload instead of auto-starting a match.
  - New menu actions wired: `New Game`, `Load From Code`.
- Added in-game code panel wiring:
  - `Code` header toggle opens/closes panel.
  - `Refresh Code`, `Copy Code`, `Load Code`, `Close` are wired.
- Added code engine in `game.js`:
  - Versioned format `HKK1.<payload>.<checksum>`.
  - UTF-8 base64url payload encoding/decoding.
  - FNV-style checksum validation.
  - Snapshot serialization of full round/match state (players, field, pile, pending states, multiplier, logs, etc.).
  - Snapshot validation for shape/types/known card IDs.
  - Hydration + runtime state ownership checks to prevent duplicate-card corruption.
  - Resume logic after load for CPU pending decision/deck-flip flows.
- Added styles for new UI elements in `style.css`:
  - `.top-actions`, `.code-panel*`, `.start-menu*`, status states.
- Smoke check run via local HTTP server (outside sandbox):
  - `index.html`, `game.js`, `style.css` all served with HTTP 200.
  - Confirmed HTML contains `#code-panel`, `#start-menu`, `#start-load-btn`.
- Test limitation:
  - Playwright scripted smoke test could not be run in this environment because `node`/`npx` are unavailable.
- Removed CPU avatar/profile UI per mobile layout fix request.
- CPU hand area now renders as a single 1x8 horizontal strip on all viewports (desktop unchanged behavior, mobile uses horizontal scroll instead of 2x4 wrap).
- CPU phase-1 reveal moved to in-hand slot:
  - during preview delay, the selected CPU hand card is shown face-up in its actual hand position;
  - all other CPU hand cards remain face-down.
- Deleted avatar/profile markup from `index.html` and removed related CSS/JS hooks.
- Validation smoke check:
  - `index.html` served 200, contains only `#cpu-hand` in CPU hand section.
  - Confirmed avatar/profile selectors no longer exist in served HTML/CSS.
- CPU hand readability tweak: phase-1 CPU reveal is now left-anchored.
- During CPU preview, selected card is rendered in the leftmost CPU-hand slot; remaining cards are shown after it.
- Visual effect: CPU hand now reads like a train queue (left shown card -> card leaves -> remaining hand shifts).
- Gameplay logic unchanged; this is a display-only reorder in `renderHands()`.
- Major HUD refactor applied:
  - Removed old `CPU | Game x/12 | You` score/meta row.
  - Added inline score badges to hand headers:
    - `CPU Hand` now includes red/bold `#cpu-score-inline`.
    - `Your Hand` now includes red/bold `#player-score-inline`.
  - Added `turn-meta` line in field section: `Starts: ... | Turn: ...`.
- Bottom title row button cluster updated:
  - Added `Game 1 / 12` button to the right-side cluster, to the left of `Action Log`.
  - Right-side order is now: `Game 1/12`, `Action Log`, `Code`, `Rules`.
- Added match round summary system:
  - New panel `#game-summary-panel` with 4 columns: `Month`, `You`, `CPU`, `Mult`.
  - Populated from new state field `roundHistory` and rendered by `renderRoundSummary()`.
  - Unplayed rounds show `-`; no-score rounds are marked via styling in `Mult` column.
- Save system updated for new round summary data:
  - Save code version bumped to `HKK2` (`SAVE_CODE_PREFIX = "HKK2"`, `SAVE_CODE_VERSION = 2`).
  - Snapshot now includes required `roundHistory`.
  - Validation/hydration now enforces roundHistory schema and restores it.
  - This is intentionally not backward compatible with old `HKK1` codes.
- Round history write paths:
  - `endRoundWithWinner`: records month + winner points + multiplier.
  - `endRoundDraw`: records month with 0/0 and current multiplier.
- Structural cleanup:
  - Rewrote `index.html` to a single valid document (previous duplicate full-document artifact removed).
- Smoke check:
  - Local server served updated HTML/CSS/JS (HTTP 200).
  - Confirmed new markers for inline scores, game-summary button/panel, and `HKK2` save constants.
- Moved `CPU Hand` section to sit directly above `Your Hand` (new order: captures -> field -> CPU hand -> player hand).
- Added compact CPU-hand-only card sizing (about 60% of player hand size):
  - mobile/default: `44x55`
  - desktop: `50x62`
- Kept `CPU Hand` and `Your Hand` header text/score styling unchanged and consistent.
- No gameplay logic changes; display-only layout and sizing update.
- Implemented reversible Phase-1 hand preview flow improvements:
  - Hand preview pending states now fully support both `handMatch` and `handPlace` through save/load (`serialize`, `validate`, `hydrate`).
  - `handPlace` pending ownership is now validated on hydrated states.
- Added no-match placement preview in Field:
  - While previewing a no-match hand card, a duplicate ghost card now appears in Field with the same glow language as choice targets.
  - Preview card is visually marked as a placement preview (`PLACE`) and remains non-interactive.
- Instruction bar now uses contextual pending prompts:
  - Replaced generic "Finish field choice above." with `getChoicePromptText(pending)` so hand-preview states explicitly tell the player to confirm/cancel.
- Focus behavior refined for preview type:
  - `handPlace` preview now auto-focuses to player-hand zone instead of field zone; match previews still focus field.
- Adjusted no-match placement interaction for consistency:
  - `handPlace` now confirms by tapping the glowing preview card in the Field (not by tapping hand card again).
  - Tapping the selected hand card again now cancels preview and returns to hand selection.
  - `handPlace.options` now includes the pending hand card id so field-click routing can resolve the preview target.
- Updated handPlace instruction copy:
  - Prompt now says to tap preview field card to place, or selected hand card to cancel.
- Auto-focus behavior updated:
  - `handPlace` pending now focuses Field (confirm target) instead of player hand.
- Visual affordance update:
  - Preview placement card keeps glow and is now marked selectable for cursor/interaction consistency.
- Smoke check:
  - Local server served `index.html` and `game.js` with HTTP 200 on port 5185.
- Hand-match preview cancel parity implemented:
  - While `handMatch` preview is active, tapping the selected hand card again now cancels preview (same behavior as `handPlace`).
  - Switching to a different hand card during preview still works as before.
- Updated hand-match instruction copy to include explicit cancel guidance and 3-match sweep wording.
- Smoke check: local server served `index.html` and `game.js` with HTTP 200 on port 5185.
- Phase 1 (multiplayer groundwork) implemented with no gameplay-flow switch yet.
- Save/version layer:
  - Save prefix/version bumped to `HKK3` / `v3` for new exports.
  - Backward loader now accepts `HKK2` and `HKK3` via prefix->version map.
  - Added strict prefix/version pairing check (`Version mismatch for <prefix>`).
- New multiplayer-ready state fields added:
  - `playMode`, `friendFlow`, `viewerPlayerIndex`, `interstitial`, `turnCheckpointReady`, `lastExportMeta`.
- Snapshot schema expanded for `v3` only:
  - serializes/deserializes/validates new multiplayer-ready fields.
  - `v2` snapshots skip these new checks and load with safe defaults.
- Player model expanded:
  - `createPlayer(name, isHuman, roleLabel)` now supports `roleLabel` for upcoming friend-mode labeling.
  - Snapshot player entries now include optional `name`, `roleLabel`, `isHuman`.
- Applied safe defaults for new fields on:
  - `startNewMatch()` and `startRound()`.
  - `applySnapshot()` when loading legacy `HKK2` snapshots.
- Added `computeTurnCheckpointReady()` and wired it into render/export so checkpoint metadata is computed from live state.
- Added multiplayer metadata to `render_game_to_text` payload for test/debug visibility.
- Smoke check: local HTTP server returned 200 for `index.html` and updated `game.js` on port 5185.
- Test limitation: could not run Playwright scripted smoke in this environment because `npx` is unavailable.
- Step 2 implemented: start-menu mode selection + friend flow selection wiring.
- Start menu UI changed:
  - Replaced single `New Game` with `Play with CPU` and `Play with Friend`.
  - Added friend sub-flow chooser (hidden by default):
    - `Hotseat (Same Phone)`
    - `Code-Send (Two Devices)`.
- Added start-menu UI ids and handlers:
  - `start-mode-cpu-btn`, `start-mode-friend-btn`, `start-friend-flow`, `start-friend-hotseat-btn`, `start-friend-code-btn`.
  - New handlers: `onStartModeCpuFromMenu`, `onStartModeFriendFromMenu`, `onStartFriendHotseatFromMenu`, `onStartFriendCodeFromMenu`.
  - Added `setStartFriendFlowOpen()` and reset it in `showStartMenu()`/`hideStartMenu()`.
- `startNewMatch(options)` now supports mode args:
  - `{ playMode: "cpu" }` starts current CPU behavior.
  - `{ playMode: "friend", friendFlow: "hotseat"|"code" }` initializes two-human players (`Player 1`, `Player 2`) and sets friend state fields.
  - Default behavior with no args now uses existing `state.playMode/state.friendFlow` so New Match can preserve mode in future flows.
- CSS additions for new start menu layout:
  - `.start-mode-actions`, `.start-friend-flow`, `.start-subtitle`.
- Smoke check:
  - local HTTP server returned 200 for `index.html`, `style.css`, and `game.js` on port 5185.
- Test limitation:
  - Playwright smoke test not run here because `npx` is unavailable.
- Fixed start-menu friend-mode submenu glitch:
  - Added `.start-friend-flow[hidden] { display: none !important; }` so hidden state is respected.
  - Updated `onStartModeFriendFromMenu()` to toggle submenu open/closed instead of only forcing open.
- Smoke check: index/js/css all served HTTP 200 on port 5185.
- Step 3 (Visibility policy integration) implemented in render/input layer.
- Added visibility/input policy helpers:
  - `isFriendMode`, `getViewerPlayerIndex`, `getDisplayBottomPlayerIndex`, `getDisplayTopPlayerIndex`, `canRevealBottomHand`, `getInteractiveHumanPlayerIndex`.
- Input flow now targets dynamic interactive human player (not hardcoded player 0):
  - `onPlayerHandClick`, `previewPlayerHandCard`, `clearPlayerHandPreview`, `onFieldClick`, and `onDrawPreviewClick` updated.
  - In friend mode, input is blocked unless `viewerPlayerIndex === currentPlayer`.
- Render flow now uses viewer/opponent mapping:
  - `renderTop`, `renderHands`, `renderField`, `renderChoiceMode`, `renderCaptured` updated to respect display indices.
  - Opponent/top hand is always hidden (backs), bottom hand visibility controlled by `canRevealBottomHand()`.
  - If bottom hand is not visible, it renders backs only and remains locked.
- Focus/action targeting updated for dynamic interactive player in `getActiveActionFocusKey`.
- `startRound()` now resets friend viewer to current turn owner (`viewerPlayerIndex = currentPlayer`) in friend mode.
- `render_game_to_text` updated with visibility metadata and masked bottom hand output when hidden.
- Safety fix for legacy/HKK2 load in CPU mode:
  - `applySnapshot()` now defaults `viewerPlayerIndex` to `0` for CPU mode (prevents accidental CPU-hand reveal on loads where `currentPlayer===1`).
- Smoke checks:
  - Local HTTP server served `index.html` and updated `game.js` with HTTP 200 on port 5185.
- Test limitation:
  - Playwright smoke not run in this environment (`npx` unavailable).
- Step 4 implemented: friend labels + text normalization across live HUD/status copy.
- Dynamic label binding now updates hand/capture headers and round-summary column headers from player names (`Player 1/Player 2` in friend mode, `You/CPU` in cpu mode).
- Added `getLatestRoundOutcome()` and switched round-end instruction text to derive from `roundHistory` state instead of hardcoded `You|CPU` regex matching.
- Match-end instruction text now uses dynamic player names (`<name> wins ...`) and no longer assumes `You/CPU`.
- CPU-turn muted note now uses current player name (`<name> playing.`), keeping copy mode-safe.
- Decision prompt forced-koi line now uses owner name (`<name> is forced to Koi-Koi.`).
- Smoke check: local server on port 5185 returned HTTP 200 for `/` and `/game.js`; verified updated markers in served JS (`getLatestRoundOutcome`, dynamic wins text).
- Test limitation: Playwright scripted smoke still not run in this environment because `node`/`npx` are unavailable.
- Step 5 implemented: friend-mode turn handoff flow (hotseat + code-send) with interstitial overlay.
- Added new UI overlay (`#friend-interstitial`) with mode-aware content:
  - Hotseat: privacy pass screen + ready/continue confirmation.
  - Code-send: share screen with generated turn code + copy button + optional continue on same device.
- Added friend interstitial state/render/event wiring:
  - New UI bindings in `cacheUI()` and handlers in `bindUI()`.
  - New helpers: `setFriendInterstitialOpen`, `prepareFriendTurnHandoff`, `onFriendInterstitialCopyCode`, `onFriendInterstitialContinue`, `setFriendInterstitialStatus`, `renderFriendInterstitial`.
- Turn transition integration:
  - `moveToNextPlayer()` now records friend handoff metadata (`lastExportMeta`) and opens interstitial in friend mode at end-of-turn handoff.
  - CPU mode remains unchanged.
- Code-send import behavior:
  - In `applySnapshot()`, if loaded state is friend+code and interstitial is open, importer auto-claims next-player perspective and closes interstitial so play can continue immediately.
- Checkpoint readiness update:
  - `computeTurnCheckpointReady()` now returns false during hotseat interstitial lock state.
- Menu behavior hardening:
  - Opening/closing start menu now also closes friend interstitial state.
- Smoke check:
  - Local HTTP server on 5185 returned 200 for `/`, `/style.css`, `/game.js`.
  - Verified new HTML/JS/CSS markers for friend interstitial and handoff functions.
- Test limitation:
  - Playwright scripted smoke still not run in this environment (`node`/`npx` unavailable).
- Step 6 implemented: friend code-share UX normalization + turn-code guardrails.
- Code panel now has dynamic friend-code labeling:
  - Header: `Turn Code` (friend code mode) vs `Save / Load Code` (default).
  - Export label: `Current turn code`.
  - Import label/placeholder: `Load turn code` / `Paste turn code from other player`.
  - Buttons: `Generate Turn Code` and `Copy Turn Code` in friend code mode.
- Added mode guards for friend code flow:
  - `Refresh` and `Copy` actions are blocked unless in handoff/export window (`isFriendTurnExportWindow()`).
  - Clear status messages explain why actions are disabled before handoff.
- Added helpers:
  - `isFriendCodeMode()`
  - `isFriendTurnExportWindow()`
  - `renderCodePanel()` (called in `renderAll` for live button text/disabled state).
- Added code-panel DOM ids for dynamic text updates:
  - `#code-panel-head`, `#export-code-label`, `#import-code-label`.
- Smoke check:
  - Local server on 5185 returned HTTP 200 for `/` and `/game.js`.
  - Verified HTML ids and JS markers for new phase-6 functions/messages are present in served output.
- Test limitation:
  - Playwright scripted smoke still unavailable in this environment (`node`/`npx` not present).
- Step 7 implemented: friend code-turn checkpoint enforcement + stronger import/export guardrails.
- Turn-code import now validates checkpoint state:
  - In `loadCodeIntoGame()`, friend code snapshots are rejected unless `turnCheckpointReady === true`.
  - Error shown: `This turn code is not at a valid handoff checkpoint`.
- Friend code load success messaging now includes exporter metadata when available:
  - `Turn code loaded (Player X, move N).`
- `computeTurnCheckpointReady()` semantics tightened:
  - In friend code mode, checkpoint is true only while interstitial handoff is open.
  - Prevents non-handoff states from being treated as valid turn export checkpoints.
- UI guard hardening for export textarea:
  - While in friend code mode outside handoff window, export textarea is cleared.
  - Placeholder now explains: `Turn code appears after a full turn handoff.`
  - Prevents easy manual copy from prefilled textarea before a full-turn checkpoint.
- Interstitial text now includes move metadata from `lastExportMeta` when present (e.g., `Player 1 move 3`).
- Smoke check:
  - Local server on 5185 returned HTTP 200 for `/` and `/game.js`.
  - Verified served markers for checkpoint validation, updated status copy, and export textarea guard.
- Test limitation:
  - Playwright scripted smoke still unavailable in this environment (`node`/`npx` missing).
- Share-link UX update implemented for multiplayer handoff + save/load.
- Code panel is now link-first:
  - Added `Copy Turn Link` action.
  - Added `Advanced` toggle that reveals raw-code textarea/actions only when needed.
  - Import copy now reads `Load from link or code` with link/code parsing on load.
- Start-menu and friend-handoff copy updated to link-first language (`Enter Link or Code`, `Copy Turn Link`, `Load Turn Link`).
- Added robust link/code parsing + generation helpers:
  - `buildShareLinkFromCode(code)` for `#t=` links.
  - `extractCodeFromInput(raw)` accepts raw `HKK...`, `#t=...`, full URL hash/query token forms.
  - `tryLoadFromLocationHash()` supports direct-open handoff links and clears hash after successful load.
- Friend interstitial copy now exports link text (not raw code) while retaining strict checkpoint validation.
- Smoke check (escalated local bind) passed on port 5185:
  - `/`, `/game.js`, `/style.css` all HTTP 200.
  - Verified markers for `copy-link-btn`, `toggle-advanced-btn`, `code-advanced`,
    `buildShareLinkFromCode`, `extractCodeFromInput`, and `tryLoadFromLocationHash`.
- UX cleanup pass for turn-link loading implemented (clipboard-first, less clutter).
- Start menu now defaults to simple actions:
  - `Load Turn Link` attempts clipboard auto-load first.
  - Manual paste area is hidden by default and only revealed when clipboard is unavailable/empty or invalid.
  - Added fallback controls: `#start-manual-load-wrap`, `#start-load-manual-btn`.
- Friend interstitial now defaults to clean handoff controls:
  - Removed visible turn-link dump textarea from normal flow.
  - `Load Turn Link` is clipboard-first; manual paste section appears only on failure.
  - Added fallback controls: `#friend-manual-load-wrap`, `#friend-load-manual-btn`.
- Added JS helpers for smart loading:
  - `readClipboardTextSafe()`
  - `tryLoadFromClipboardOrManual(target)`
  - visibility toggles `setStartManualLoadVisible()` / `setFriendManualLoadVisible()`.
- Friend copy-link flow no longer depends on rendering a visible textarea; fallback copy uses a temporary hidden textarea only when needed.
- Smoke check (escalated local bind) passed on port 5185:
  - `/` served HTTP 200.
  - Verified new marker ids for manual fallback wrappers/buttons.
  - Verified old interstitial turn-link dump marker is absent from served HTML.
- Multiplayer autoplay bugfix (friend link-import handoff):
  - Root cause: post-load resume logic used hardcoded AI index `1`, which collides with friend mode where Player 2 is also index `1`.
  - Added `getCpuPlayerIndex()` and switched AI resume/scheduling to target the actual non-human player only.
  - Updated `resumeLoadedStateFlow`, `resolveCpuPendingDecision`, `resumeCpuDeckFlipFlow`, `queueAITurn`, and `performAITurn` to use CPU index discovery instead of `=== 1` assumptions.
  - Updated phase-1 CPU preview cleanup in `executePlayFromHand()` to clear by actual CPU index.
- Friend import safety hardening:
  - When loading from the friend interstitial (`target="friend"`), non-friend snapshots now fail fast with `This is not a friend turn link`.
  - On snapshot hydrate, friend mode now forces both players to `isHuman=true` to prevent unintended AI scheduling from malformed/tampered payloads.
- Implemented lightweight friend handoff "Turn Recap Playback" (visual narration, not deterministic simulation).
- New recap state added:
  - `activeTurnRecap` (in-progress turn summary),
  - `lastTurnRecap` (serialized handoff summary),
  - `turnReplay` (playback runtime: active/note/timer/key).
- Turn recap capture now records:
  - phase-1 played card + hand result (capture/place/sweep),
  - draw card + draw result (capture/place/sweep/deck-empty),
  - pass/koi decision + multiplier transition.
- Handoff integration:
  - on turn handoff (`moveToNextPlayer`), recap is committed for export/import.
  - on friend hotseat continue and friend link import, receiver gets staged recap playback.
- Playback behavior:
  - drives `Recent Deck Pull` visuals + instruction bar text over short timed beats,
  - locks input while replay is active (`getInteractiveHumanPlayerIndex` returns null),
  - auto-focuses draw preview during replay and then returns to normal state.
- Save payload integration:
  - `lastTurnRecap` included in snapshot and validated/hydrated.
- Smoke check (escalated local bind) passed on port 5185:
  - `/` served HTTP 200.
  - Verified markers for recap capture/playback functions and friend handoff hooks in served JS.
- Phase-2 human no-match flow updated to require field confirmation click (parity with phase-1 no-match placement UX).
- Added new pending selection mode: `drawPlace`.
  - On human draw reveal with no match, card is now staged as preview on field.
  - Player must tap highlighted preview field card to place and continue.
- Added `resolveDrawPlace(...)` and wired `onFieldClick(...)` for `drawPlace`.
- Extended save/load support for `drawPlace`:
  - serialize/validate/hydrate pending selection now handles `drawPlace`.
  - hydrated ownership checks now allow `drawPlace` preview option to reference the drawn card (not field card).
- Updated field render + instruction copy to show draw placement preview and explicit prompt text.
- Smoke check (escalated local bind) passed on port 5185:
  - `/` served HTTP 200.
  - Verified served JS markers for `drawPlace` and `resolveDrawPlace` flow.
- Multiplayer recap readability pass:
  - During replay, draw panel header now switches from `Recent Deck Pull` to `Player X Recap`.
  - Recap pacing slowed (`TURN_REPLAY_STEP_MS` increased to 1500ms) for easier reading.
  - Added recap-only flashing visual treatment on recent-card panel (`.draw-preview.recap-active`) with `recapFlash` keyframes.
- Smoke check (escalated local bind) passed on port 5185:
  - `/` served HTTP 200.
  - Verified markers for `draw-preview-label`, recap label toggle in JS, updated replay timing constant, and recap flash CSS.
- Recap sequencing updated to explicit staged beats per turn (friend multiplayer handoff).
- Replaced old single-summary replay line with structured `buildTurnRecapSteps(...)` flow:
  - phase 1 hand pick (`selected ... from hand`)
  - phase 1 result (capture/sweep/place)
  - phase 2 deck pull (`drew ... from deck`)
  - phase 2 result (capture/sweep/place/deck-empty)
  - optional pass/koi decision beat using last turn card as visual anchor
  - final `Your turn.` step
- This preserves the existing recap location and visuals while making each action legible in order.
- Smoke check (escalated local bind) passed on port 5185:
  - `/` served HTTP 200.
  - Verified served JS markers for `buildTurnRecapSteps` and staged recap step text.
- Recap navigation changed to hybrid mode:
  - auto-advance every `2600ms` (`TURN_REPLAY_STEP_MS = 2600`)
  - tap-to-advance enabled on the recap panel during replay
  - tap guard added (`TURN_REPLAY_TAP_GUARD_MS = 220`) to avoid accidental double-skip
- Recap step copy now includes inline guidance:
  - intermediate steps: `Tap to continue (n/total).`
  - final step: `Tap to start your turn.`
- Implemented shared replay step runner `advanceTurnReplayStep(...)` so timer and tap use the same progression logic.
- Smoke check (escalated local bind) passed on port 5185:
  - `/` served HTTP 200.
  - Verified served JS markers for hybrid recap constants and step runner.
- Step 8 implemented: strict friend code-turn import invariants.
- Added `validateFriendCodeSnapshotForImport(snapshot)` and applied it in `loadCodeIntoGame()` before hydration.
- Friend code imports now require all of the following:
  - `playMode === friend` and `friendFlow === code` snapshots must be at handoff checkpoint (`turnCheckpointReady === true`).
  - `interstitial.open === true` with a valid `nextPlayerIndex`.
  - `currentPlayer` must match `interstitial.nextPlayerIndex`.
  - `lastExportMeta` must exist with valid exporter index and positive turn number.
  - exporter must differ from receiver (`nextPlayerIndex`).
- This closes remaining loopholes where malformed/non-handoff friend snapshots could still be loaded.
- Smoke check:
  - Local server on 5185 returned HTTP 200 for `/` and `/game.js`.
  - Verified served JS markers for `validateFriendCodeSnapshotForImport` and new invariant error strings.
- Test limitation:
  - Playwright scripted smoke still unavailable in this environment (`node`/`npx` missing).
- Unified friend mode update implemented (merged former hotseat/code branches into one flow).
- Start menu now has one `Play with Friend` action (no friend sub-mode chooser).
- Friend interstitial now always supports both handoff paths:
  - local pass-device (`<Next Player> Ready`)
  - async code-send (`Copy Turn Code`)
  - plus in-panel import (`Load Turn Code`) via new `#friend-import-code` and `#friend-load-code-btn`.
- Added interstitial import handler:
  - `onFriendInterstitialLoadCode()` calls `loadCodeIntoGame(..., "friend")`.
  - `setCodeStatus()` now supports `target="friend"` so load/copy errors render in interstitial status area.
- Normalized friend flow state:
  - Default `state.friendFlow` is now `hybrid`.
  - `normalizeFriendFlow()` maps legacy `hotseat`/`code`/`hybrid` to runtime `hybrid`.
  - `validateFriendFlow()` now accepts `hotseat`, `code`, and `hybrid` for backward compatibility.
- Snapshot apply behavior updated:
  - Friend snapshots with open interstitial now auto-claim next player perspective regardless of legacy flow value.
- Turn checkpoint logic unified:
  - `computeTurnCheckpointReady()` now uses `interstitial.open` for all friend mode.
- Friend import strictness retained and broadened:
  - strict handoff validation now applies to all friend snapshots (not just legacy `friendFlow===code`).
- Removed obsolete friend subflow CSS blocks from `style.css`.
- Smoke checks:
  - local HTTP server returned 200 for `/`, `/game.js`, and `/style.css`.
  - verified new friend interstitial import ids/events and absence of stale `start-friend-flow` CSS selectors in served assets.
- Test limitation:
  - Playwright scripted smoke still unavailable in this environment (`node`/`npx` missing).
