<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>Hanafuda Koi-Koi</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <main class="app">
      <section class="captured-zone">
        <div class="captured-col">
          <div class="zone-header compact">
            <span id="cpu-captures-label">CPU Captures</span>
            <span id="cpu-captured-count">0</span>
          </div>
          <div id="cpu-captured" class="captured-grid"></div>
          <div id="cpu-yaku" class="yaku-line">No set</div>
        </div>
        <div class="captured-col">
          <div class="zone-header compact">
            <span id="player-captures-label">Your Captures</span>
            <span id="player-captured-count">0</span>
          </div>
          <div id="player-captured" class="captured-grid"></div>
          <div id="player-yaku" class="yaku-line">No set</div>
        </div>
      </section>

      <section id="field-zone" class="field-zone">
        <div class="zone-header">
          <span>Field</span>
          <span class="field-meta">
            <span id="deck-count">Deck: 24</span>
          </span>
        </div>
        <div class="field-koi-row">
          <span id="koi-state" class="koi-state mult-1">Table 1x | Last Koi-Koi: none</span>
        </div>
        <div id="turn-meta" class="turn-meta">Starts: You | Turn: You</div>
        <div class="field-layout">
          <div id="field" class="field-grid"></div>
          <aside id="draw-preview" class="draw-preview">
            <div class="draw-preview-label">Recent Deck Pull</div>
            <div class="draw-preview-card">
              <canvas id="draw-preview-canvas" width="138" height="170"></canvas>
            </div>
            <div id="draw-preview-text" class="draw-preview-text">Waiting for draw.</div>
          </aside>
        </div>
      </section>

      <section class="opponent-zone">
        <div class="zone-header">
          <span id="cpu-hand-label" class="zone-title-with-score">CPU Hand <strong id="cpu-score-inline" class="header-score">0</strong></span>
          <span id="cpu-hand-count">8 cards</span>
        </div>
        <div id="cpu-hand" class="cpu-hand-strip"></div>
      </section>

      <section id="player-zone" class="player-zone">
        <div class="zone-header">
          <span id="player-hand-label" class="zone-title-with-score">Your Hand <strong id="player-score-inline" class="header-score">0</strong></span>
        </div>
        <div id="hand-lock-note" class="hand-lock-note is-muted"></div>
        <div id="player-hand" class="hand player"></div>
      </section>

      <section id="context-zone" class="context-zone">
        <button id="context-left-btn" type="button" class="context-btn" data-action="pass" disabled>
          Pass
        </button>
        <button id="context-right-btn" type="button" class="context-btn" data-action="koi" disabled>
          Koi-Koi
        </button>
      </section>

      <header class="top">
        <div>
          <h1>Hanafuda Koi-Koi</h1>
        </div>
        <div class="top-actions">
          <button id="game-summary-toggle" class="ghost" type="button">Game 1 / 12</button>
          <button id="log-toggle" class="ghost" type="button">Action Log</button>
          <button id="code-toggle" class="ghost" type="button">Code</button>
          <button id="rules-toggle" class="ghost" type="button">Rules</button>
        </div>
      </header>

      <section id="game-summary-panel" class="summary-panel" hidden>
        <div class="summary-panel-head">Round Summary</div>
        <div class="summary-table-wrap">
          <table class="summary-table">
            <thead>
              <tr>
                <th>Month</th>
                <th id="summary-col-you">You</th>
                <th id="summary-col-cpu">CPU</th>
                <th>Mult</th>
              </tr>
            </thead>
            <tbody id="round-summary-body"></tbody>
          </table>
        </div>
      </section>

      <section id="code-panel" class="code-panel" hidden>
        <div id="code-panel-head" class="code-panel-head">Save / Load Code</div>
        <div class="code-actions">
          <button id="copy-link-btn" type="button">Copy Turn Link</button>
          <button id="toggle-advanced-btn" type="button" class="ghost">Advanced</button>
        </div>
        <label id="import-code-label" class="code-label" for="import-code">Load from link or code</label>
        <textarea id="import-code" class="code-text" placeholder="Paste a link or code here"></textarea>
        <div class="code-actions">
          <button id="load-code-btn" type="button">Load</button>
          <button id="close-code-btn" type="button" class="ghost">Back to Menu</button>
        </div>
        <div id="code-advanced" class="code-advanced" hidden>
          <label id="export-code-label" class="code-label" for="export-code">Current raw code</label>
          <textarea id="export-code" class="code-text" readonly></textarea>
          <div class="code-actions">
            <button id="refresh-code-btn" type="button">Refresh Raw Code</button>
            <button id="copy-code-btn" type="button">Copy Raw Code</button>
          </div>
        </div>
        <div id="code-status" class="code-status"></div>
      </section>

      <section id="rules-panel" class="rules-panel" hidden>
        <div class="rules-pages">
          <article class="rules-copy">
            <h2>How To Play</h2>
            <p>Everything below is written for new players and matches this version's house rules.</p>

            <details class="rules-section" open>
              <summary>Objective</summary>
              <ul>
                <li>Win points by making card combinations called <strong>yaku</strong>.</li>
                <li>A full match is 12 rounds (January through December).</li>
                <li>The highest total score after 12 rounds wins.</li>
              </ul>
            </details>

            <details class="rules-section">
              <summary>Cards and Matching</summary>
              <ul>
                <li>The deck has 48 cards: 12 months, 4 cards per month.</li>
                <li>You match cards by <strong>month</strong>.</li>
                <li>Type markers on cards: <strong>BRT</strong> = bright, <strong>SED</strong> = seed, <strong>SCR</strong> = scroll, <strong>PLN</strong> = plain.</li>
              </ul>
            </details>

            <details class="rules-section">
              <summary>Setup (Each Round)</summary>
              <ul>
                <li>Each player gets 8 cards in hand.</li>
                <li>8 cards are placed face-up on the field.</li>
                <li>Remaining cards form the draw deck.</li>
                <li>Round month follows round number (Round 1 January ... Round 12 December).</li>
              </ul>
            </details>

            <details class="rules-section">
              <summary>Turn Structure</summary>
              <ul>
                <li><strong>Phase 1:</strong> Play one card from hand and resolve month matches.</li>
                <li><strong>Phase 2:</strong> Draw one card from deck and resolve month matches.</li>
                <li>If no match is made, that card stays on the field.</li>
              </ul>
            </details>

            <details class="rules-section">
              <summary>Capture Rules</summary>
              <ul>
                <li>If exactly 1 matching field card exists, capture both cards.</li>
                <li>If exactly 2 matching field cards exist, choose 1 field card to capture.</li>
                <li>If exactly 3 matching field cards exist, capture all 4 cards.</li>
                <li><strong>4-of-month sweep:</strong> if your played/drawn card is the 4th while other 3 are on field, capture all 4.</li>
              </ul>
            </details>

            <details class="rules-section">
              <summary>Yaku, Pass, and Koi-Koi</summary>
              <ul>
                <li>When you form a <strong>new yaku</strong>, choose to <strong>Pass</strong> or call <strong>Koi-Koi</strong>.</li>
                <li><strong>Pass:</strong> round ends and scorer gets <code>yaku points x table multiplier</code>.</li>
                <li><strong>Koi-Koi:</strong> round continues and table multiplier increases by 1 (max 4x).</li>
                <li>Multiplier starts at 1x every round.</li>
                <li>Only the player who ends the round by passing scores that round.</li>
                <li>If deck/hands run out before pass, the <strong>last Koi-Koi caller</strong> scores at current multiplier.</li>
                <li>Point add-ons to an existing yaku do <strong>not</strong> create a new pass/Koi-Koi decision.</li>
              </ul>
            </details>

            <details class="rules-section">
              <summary>Round-to-Round Start Rules</summary>
              <ul>
                <li>If winner scored at <strong>3x or 4x</strong>, winner starts next round.</li>
                <li>If winner scored at <strong>1x or 2x</strong>, loser starts next round.</li>
                <li>If a round has no scoring yaku, do not replay it; carry starter logic from the most recent scored round.</li>
                <li><strong>1x carryover bonus (next round only):</strong> after a 1x win, the loser starts and may pass first yaku at 2x, or call Koi-Koi to jump to 3x.</li>
                <li>If the previous 1x winner gets first yaku instead, they use normal options (pass at 1x or Koi-Koi to 2x).</li>
                <li><strong>Round 12 leader rule:</strong> if the leading player forms first yaku at 1x, they must Koi-Koi (except when special 2x pass privilege applies).</li>
              </ul>
            </details>

            <details class="rules-section">
              <summary>Scoring (Yaku List)</summary>
              <ul>
                <li>Five Brights: 10</li>
                <li>Four Brights: 8 (or 7 with rain bright)</li>
                <li>Three Brights (no rain bright): 5</li>
                <li>Blossom Viewing (Cherry Bright + Sake Cup): 5</li>
                <li>Moon Viewing (Moon Bright + Sake Cup): 5</li>
                <li>Animal Trio set: 5</li>
                <li>Red Scroll set: 5</li>
                <li>Blue Scroll set: 5</li>
                <li>Red and Blue Scroll sets together: 10</li>
                <li>Seeds: 5 seeds = 3, then +1 per extra seed</li>
                <li>Scrolls: 5 scrolls = 1, then +1 per extra scroll</li>
                <li>Plains: 10 plains = 1, then +1 per extra plain</li>
                <li>Sake Cup counts as seed only (not plain).</li>
                <li>Round Month Sweep (all 4 cards of current round month): 5</li>
              </ul>
            </details>

            <details class="rules-section">
              <summary>Quick Start</summary>
              <ul>
                <li>Match by month.</li>
                <li>Resolve hand play, then resolve deck pull.</li>
                <li>Build yaku in your captured cards.</li>
                <li>On a new yaku, decide Pass (bank now) or Koi-Koi (raise stakes).</li>
                <li>Highest total after 12 rounds wins.</li>
              </ul>
            </details>
          </article>
        </div>
      </section>

      <section id="message-zone" class="message-zone" hidden>
        <div class="zone-header compact">
          <span>Action Log</span>
          <span id="log-count">0</span>
        </div>
        <ol id="action-log" class="action-log">
          <li>SYS: Loading cards...</li>
        </ol>
      </section>
    </main>

    <section id="start-menu" class="start-menu">
      <div class="start-card">
        <h2>Hanafuda Koi-Koi</h2>
        <p>Choose how you want to play, or load from a link or code.</p>
        <div class="start-actions start-mode-actions">
          <button id="start-mode-cpu-btn" type="button" class="primary">Play with CPU</button>
          <button id="start-mode-friend-btn" type="button">Play with Friend</button>
        </div>
        <div class="start-subtitle">Friend mode supports both pass-device and turn-code handoff each turn.</div>
        <div class="start-actions">
          <button id="start-load-btn" type="button">Load Turn Link</button>
        </div>
        <div id="start-manual-load-wrap" class="manual-load-wrap" hidden>
          <label class="code-label" for="start-import-code">Load turn link or code</label>
          <textarea id="start-import-code" class="code-text" placeholder="Paste a save/share link or code here"></textarea>
          <div class="start-actions">
            <button id="start-load-manual-btn" type="button">Load Pasted Link</button>
          </div>
        </div>
        <div id="start-menu-status" class="code-status"></div>
      </div>
    </section>

    <section id="friend-interstitial" class="friend-interstitial" hidden>
      <div class="friend-interstitial-card">
        <h2 id="friend-interstitial-title">Friend Turn Handoff</h2>
        <p id="friend-interstitial-text">Turn complete. Pass device or share turn link.</p>
        <div id="friend-manual-load-wrap" class="manual-load-wrap" hidden>
          <label class="code-label" for="friend-import-code">Load turn link or code</label>
          <textarea id="friend-import-code" class="code-text" placeholder="Paste turn link or code from other player"></textarea>
          <div class="start-actions">
            <button id="friend-load-manual-btn" type="button">Load Pasted Link</button>
          </div>
        </div>
        <div class="start-actions friend-interstitial-actions">
          <button id="friend-copy-code-btn" type="button">Copy Turn Link</button>
          <button id="friend-load-code-btn" type="button">Load Turn Link</button>
          <button id="friend-continue-btn" type="button" class="primary">Pass Device</button>
        </div>
        <div id="friend-interstitial-status" class="code-status"></div>
      </div>
    </section>

    <script src="game.js"></script>
  </body>
</html>
